title: Print spooler privilege escalation via printer added (CVE-2020-1048)
description: Detects scenarios where an attacker abuse the printer spooler features to load a DLL. The attack is composed by 4 steps > 1) create a printer that points to a missing DLL 2) print to that port 3) crash the printer spool 4) have his original DLL registered for privilege escalation.
reference:
- https://twitter.com/aionescu/status/1260466215299973121
- https://windows-internals.com/printdemon-cve-2020-1048/
tags:
- attack.privilege_escalation
- attack.t1547.010
author: Emir Erdogan (shortly adapted by mdecrevoisier)
status: experimental
logsource:
  product: windows
  category:
    - ps_module
    - ps_classic_script
    - ps_script
detection: # full command "Add-PrinterPort -Name c:\windows\system32\\*.exe'"
  selection_powershell_native:
    EventID: 800
    EventData|contains|all:
      - Add-PrinterPort
      - Name
    EventData|contains:
      - .exe
      - .dll

  selection_powershell_modern:
    EventID: 4103
    Payload|contains|all:
      - Add-PrinterPort
      - Name
    Payload|contains:
      - .exe
      - .dll

  selection_powershell_block:
    EventID: 4104
    ScriptBlockText|contains|all:
      - Add-PrinterPort
      - Name
    ScriptBlockText|contains:
      - .exe
      - .dll

  condition: selection_powershell_native or selection_powershell_modern or selection_powershell_block
falsepositives:
- unknown
level: high