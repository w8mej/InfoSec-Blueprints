title: Possible Follina/CVE-2022-30190 - a MS Office Code Execution Vulnerability Exploitation (via registry_event)
id: 113a361a-8126-448d-9980-79b160eadb1d
status: stable
description: Possible abuse of ms-msdt MSProtocol URI scheme to load and execute malicious code.
author: SOC Prime Team
references:
    - https://pbs.twimg.com/media/FUFwIPkXEAMwIXh?format=png&name=large
    - https://twitter.com/SecurityAura/status/1531338505170853889
    - https://twitter.com/Max_Mal_/status/1438146033406599169
    - https://github.com/JohnHammond/msdt-follina
    - https://doublepulsar.com/follina-a-microsoft-office-code-execution-vulnerability-1a47fce5629e
    - https://app.any.run/tasks/713f05d2-fe78-4b9d-a744-f7c133e3fafb/
    - https://twitter.com/nao_sec/status/1530196847679401984
    - https://blog.syss.com/posts/abusing-ms-office-protos/
    - https://research.checkpoint.com/2023/behind-the-scenes-of-bbtok-analyzing-a-bankers-server-side-components/
tags:
    - attack.defense_evasion
    - attack.t1221
logsource:
    product: windows
    category: registry_event
detection:
    selection_reg:
        TargetObject|contains|all:
            - 'Microsoft' #HKEY_USERS\$USER_SID\SOFTWARE\Microsoft\Office\$OFFIVE_VERSION\Common\Internet\Server Cache
            - 'Office'
            - 'Common'
            - 'Internet'
            - 'Server'
            - 'Cache'
    selection_bin_access_key:
        TargetObject|contains: 'ms-msdt' #HKCR\ms-msdt access by susp binary.
        Image|endswith:
            - 'powershell.exe'
            - 'cscript.exe'
            - 'DllHost.exe'
            #- 'explorer.exe'
            - 'gpscript.exe'
            - 'eqnedt32.exe'
            - 'hh.exe'
            - 'cmd.exe'
            - 'MSBuild.exe'
            - 'msdt.exe'
            - 'wscript.exe'
            - 'fltldr.exe'
            - 'mshta.exe'
            - 'RegAsm.exe'
            - 'regsvcs.exe'
            - 'rundll32.exe'
            - 'regsvr32.exe'
    filters:
        - TargetObject|contains:
            - 'my.sharepoint.com' #...Cache\https://xxxx-my.sharepoint.com/personal/...
        - Image|contains|all:
            - '\Program'
            - 'Files'
    condition: (selection_reg and not filters) or selection_bin_access_key
falsepositives:
    - Unknown
level: low