title: Possible Follina/CVE-2022-30190 - a MS Office Code Execution Vulnerability Exploitation (via cmdline)
id: 1046a900-654d-4010-a491-a7cd2231eac1
status: stable
description: Possible abuse of ms-msdt MSProtocol URI scheme to load and execute malicious code.
author: SOC Prime Team
references:
    - https://nao-sec.org/2023/08/groundpeony-crawling-with-malice.html
    - https://doublepulsar.com/follina-a-microsoft-office-code-execution-vulnerability-1a47fce5629e
    - https://app.any.run/tasks/713f05d2-fe78-4b9d-a744-f7c133e3fafb/
    - https://twitter.com/nao_sec/status/1530196847679401984
    - https://blog.syss.com/posts/abusing-ms-office-protos/
    - https://msrc.microsoft.com/update-guide/vulnerability/CVE-2022-30190
    - https://gist.github.com/Samirbous/9384ee6667f8b472ee6d9dcd505bd175
    - https://research.checkpoint.com/2023/behind-the-scenes-of-bbtok-analyzing-a-bankers-server-side-components/
tags:
    - attack.defense_evasion
    - attack.t1221
    - attack.t1218
logsource:
    category: process_creation
    product: windows
detection:
    selection_office:
        ParentImage|endswith:
            - 'WINWORD.EXE'
            - 'EXCEL.EXE'
            - 'POWERPNT.EXE'
            - 'MSPUB.EXE'
            - 'VISIO.EXE'
            - 'OUTLOOK.EXE'
            - 'MSACCESS.EXE'
            - 'MSPROJECT.EXE'
            - 'ONENOTE.EXE'
    selection_lolbins:
        ParentImage|endswith:
            - 'powershell.exe'
            - 'cscript.exe'
            - 'DllHost.exe'
            #- 'explorer.exe'
            - 'gpscript.exe'
            - 'eqnedt32.exe'
            - 'hh.exe'
            - 'cmd.exe'
            - 'MSBuild.exe'
            - 'msdt.exe'
            - 'wscript.exe'
            - 'fltldr.exe'
            - 'mshta.exe'
            - 'RegAsm.exe'
            - 'regsvcs.exe'
            - 'rundll32.exe'
            - 'regsvr32.exe'
    selection_cmd:
        CommandLine|contains:
            - 'msdt.exe'
            - '../'
            - '..\'
    selection_cmd_lolbins:
        CommandLine|contains:
            - 'skip'
            - 'IT_RebrowseForFile'
            - 'IT_BrowseForFile'
            - 'ms-msdt:'
            - 'af'
            - 'PCWDiagnostic'
    slection_msdt:
        Image|endswith: 'msdt.exe'
    filters:
        - CommandLine|contains:
            - 'DeviceCenterDiagnostic'
            - 'AudioPlaybackDiagnostic'
            - 'NetworkDiagnostics'
            - 'AudioRecording'
        - Image|endswith:
            - 'chrome.exe'
    #selection_sdiag:
    #    ParentImage|endswith:
    #        - 'sdiagnhost.exe'
    #filters:
    #    Image|endswith:
    #        - 'System32\conhost.exe'
    #        - 'System32\netsh.exe'
    #        - 'System32\wpr.exe'
    #filter_csc:
    #    Image|contains|all:
    #        - 'Framework64'
    #        - 'csc.exe'
    #        - 'Microsoft.NET'
    condition: (selection_office and (selection_cmd or slection_msdt)) or (selection_lolbins and slection_msdt and selection_cmd_lolbins and not filters) #or (selection_sdiag and not (filters or filter_csc))
falsepositives:
    - Unknown
level: medium